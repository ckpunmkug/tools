#!/usr/bin/php
<?php

if(true) // define PROJECT_DIR, HOME_DIR
{//{{{//

	$realpath = realpath(__DIR__.'/..');
	if(!is_string($realpath)) {
		trigger_error("Unable to get real path to project root folder", E_USER_ERROR);
		exit(255);
	}
	define('PROJECT_DIR', $realpath);
	
	$env = getenv('HOME');
	if(!is_string($env)) {
		trigger_error("Can't get 'HOME' environment", E_USER_ERROR);
		exit(255);
	}
	define('HOME_DIR', $env);
	
}//}}}//

if(true) // define VENDOR_NAME, PROJECT_NAME
{//{{{//
	
	$basename = basename(PROJECT_DIR);
	if(!is_string($basename)) {
		trigger_error("Can't get 'basename' from 'PROJECT_DIR'", E_USER_ERROR);
		exit(255);
	}
	
	define('VENDOR_NAME', 'ckpunmkug');
	define('PROJECT_NAME', $basename);
	
}//}}}//

if(true) // require
{//{{{//
	
	set_include_path(PROJECT_DIR.'/include');
	
	require_once('class/Check.php');
	require_once('class/ArgV.php');
	require_once('class/Database.php');
	require_once('class/FileSystem.php');
	require_once('class/Source.php');
	
	require_once('component/tester.php');
	
}//}}}//

if(true) // ArgV
{//{{{//
	
	$_ = [
		"config_file" => HOME_DIR.'/.config/'.VENDOR_NAME.'/'.PROJECT_NAME.'/config.ini',
		"database_file" => HOME_DIR.'/.cache/'.VENDOR_NAME.'/'.PROJECT_NAME.'/database.sqlite',
		"shared_folder" => HOME_DIR.'/.share/'.VENDOR_NAME.'/'.PROJECT_NAME,
	];
	
	ArgV::$description = 
///////////////////////////////////////////////////////////////{{{//
<<<HEREDOC

	Default paths used:
		configuration file - {$_["config_file"]}
		database file - {$_["database_file"]}
		shared folder - {$_["shared_folder"]}
	  
HEREDOC;
///////////////////////////////////////////////////////////////}}}//

	if(true) ArgV::add([
		"-n", "--no-config", NULL, "Do not use config ini file",
		function () {
			define("NO_CONFIG", true);
		}, false
	]);

	if(true) ArgV::add([
		NULL, "--config", "<path>", "Path to config ini file",
		function ($string) {
			define("CONFIG_FILE", $string);
		}, false
	]);
	
	if(true) ArgV::add([
		NULL, "--database", "<path>", "Path to database SQLite3 file",
		function ($string) {
			define("DATABASE_FILE", $string);
		}, false
	]);
	
	if(true) ArgV::add([
		NULL, "--share", "<path>", "Path to shared folder",
		function ($string) {
			define("SHARE_DIR", $string);
		}, false
	]);
	
	if(true) ArgV::add([
		"-C", "--component", "<name>", "Component",
		function ($string) {
			define("COMPONENT", $string);
		}, true
	]);
	
	if(true) ArgV::add([
		"-A", "--action", "<name>", "Action",
		function ($string) {
			define("ACTION", $string);
		}, true
	]);
	
	if(true) ArgV::add([
		"-P", "--parameter", "<string>", NULL,
		function ($string) {
			define("PARAMETER", $string);
		}, false
	]);
	
	if(true) ArgV::add([
		"-I", "--input", "<path>", "Path to input file",
		function ($string) {
			define("INPUT_FILE", $string);
		}, false
	]);
	
	if(true) ArgV::add([
		"-O", "--output", "<path>", "Path to output file",
		function ($string) {
			define("OUTPUT_FILE", $string);
		}, false
	]);


	ArgV::apply();
	
}//}}}//

if(true && !defined('NO_CONFIG')) // load config
{//{{{//
	
	if(!defined('CONFIG_FILE')) {
		define('CONFIG_FILE', HOME_DIR.'/.config/'.VENDOR_NAME.'/'.PROJECT_NAME.'/config.ini');
	}

	$ini_contents = @file_get_contents(CONFIG_FILE);
	if(!is_string($ini_contents)) {
		if (defined('DEBUG') && DEBUG) var_dump(['config ini file' => CONFIG_FILE]);
		trigger_error("Can't get contents of config ini file", E_USER_ERROR);
		exit(255);
	}
	
	$config = @parse_ini_string($ini_contents, true, INI_SCANNER_TYPED);
	if(!is_array($config)) {
		if (defined('DEBUG') && DEBUG) var_dump(['ini contents' => $ini_contents]);
		trigger_error("Can't parse ini contents of config file", E_USER_ERROR);
		exit(255);
	}
	
	define('CONFIG', $config);
	
}//}}}//

if(true) // Database
{//{{{//
	
	if(!defined('DATABASE_FILE')) {
		define('DATABASE_FILE', HOME_DIR.'/.cache/'.VENDOR_NAME.'/'.PROJECT_NAME.'/database.sqlite'); 
	}
	
	$return = Database::open(DATABASE_FILE);
	if(!$return) {
		if (defined('DEBUG') && DEBUG) var_dump(['database file' => DATABASE_FILE]);
		trigger_error("Can't open SQLite3 database file", E_USER_ERROR);
		exit(255);
	}
	
}//}}}//

$COMPONENT = ['tester'];

if(true) // route COMPONENT
{//{{{//
	
	if(!defined('CONFIG')) {
		define('CONFIG', [COMPONENT => []]);
	}
	if(!key_exists(COMPONENT, CONFIG)) {
		trigger_error("Section for component not exists in config ini file", E_USER_ERROR);
		exit(255);
	}
	
	$in = '';	
	if(defined('PARAMETER')) {
		$in = PARAMETER;
	}
	if(defined('INPUT_FILE')) {
		$in = file_get_contents(INPUT_FILE);
		if(!is_string($in)) {
			if (defined('DEBUG') && DEBUG) var_dump(['input file' => INPUT_FILE]);
			trigger_error("Can't get contents from input file", E_USER_ERROR);
			exit(255);
		}
	}
	
	if(in_array(COMPONENT, $COMPONENT)) {
		$out = call_user_func(COMPONENT.'::main', CONFIG[COMPONENT], ACTION, $in);
		if(!is_string($out)) {
			trigger_error("Main call of '".COMPONENT."' component returned an error", E_USER_ERROR);
			exit(255);
		}
	}
	else {
		if (defined('DEBUG') && DEBUG) var_dump(['unsupported component' => COMPONENT]);
		trigger_error("Passed unsupported component", E_USER_ERROR);
		exit(255);
	}
	
	if(defined('OUTPUT_FILE')) {
		$return = file_put_contents(OUTPUT_FILE, $out);
		if(!is_int($return)) {
			if (defined('DEBUG') && DEBUG) var_dump(['output file' => OUTPUT_FILE]);
			trigger_error("Can't put contents to output file", E_USER_ERROR);
			exit(255);
		}
	}
	
}//}}}//

exit(0);

